"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>M});var n=l(350),i=l(850),s=l(919),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",v="linked-ready-maker",C="ipyflow-slice-self",h="ipyflow-slice-direct",y="ipyflow-slice",g=new Event("cleanup");class f{constructor(){this.comm=null,this.notebook=null,this.session=null,this.isIpyflowCommConnected=!1,this.executionScheduledCells=[],this.selectedCells=[],this.dirtyCells=new Set,this.waitingCells=new Set,this.readyCells=new Set,this.waiterLinks={},this.readyMakerLinks={},this.prevActiveCell=null,this.activeCell=null,this.cellsById={},this.orderIdxById={},this.cellPendingExecution=null,this.isReactivelyExecuting=!1,this.numAltModeExecutes=0,this.altModeExecuteCells=null,this.lastExecutionHighlights=null,this.executedReactiveReadyCells=new Set,this.newReadyCells=new Set,this.forcedReactiveCells=new Set,this.forcedCascadingReactiveCells=new Set,this.numPendingForcedReactiveCounterBumps=0,this.cellParents={},this.cellChildren={},this.settings={},this.lastCellMetadataMap=null}gatherCellMetadataAndContent(){const e={};return this.notebook.widgets.forEach(((t,l)=>{const n=t.model;e[n.id]={index:l,content:n.sharedModel.getSource(),type:n.type}})),e}requestComputeExecSchedule(){this.comm.send({type:"compute_exec_schedule",cell_metadata_by_id:this.gatherCellMetadataAndContent(),is_reactively_executing:this.isReactivelyExecuting})}executeCells(e){if(0===e.length)return;let t=0;for(const l of e)i.CodeCell.execute(l,this.session).then((()=>{var n;(null===(n=l.promptNode.textContent)||void 0===n?void 0:n.includes("[*]"))&&l.setPrompt(""),++t===e.length&&this.requestComputeExecSchedule()}))}toggleReactivity(){return"reactive"===this.settings.exec_mode?this.settings.exec_mode="normal":"normal"===this.settings.exec_mode&&(this.settings.exec_mode="reactive"),this.session.session.kernel.requestExecute({code:"%flow toggle-reactivity",silent:!0,store_history:!1})}bumpForcedReactiveCounter(){return this.numPendingForcedReactiveCounterBumps--,this.session.session.kernel.requestExecute({code:"%flow bump-min-forced-reactive-counter",silent:!0,store_history:!1})}computeTransitiveClosure(e,t=!0,l=!1){const n=new Set;for(const t of e)w(n,t,l?this.cellParents:this.cellChildren);if(!t)for(const t of e)n.delete(t);return Array.from(n).filter((e=>void 0!==this.cellsById[e])).filter((e=>void 0!==this.orderIdxById[e])).sort(((e,t)=>this.orderIdxById[e]-this.orderIdxById[t])).map((e=>this.cellsById[e]))}}const x={};function p(e){delete x[e]}function w(e,t,l){if(e.has(t))return;e.add(t);const n=l[t];void 0!==n&&n.forEach((t=>w(e,t,l)))}const _={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,n.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,n;const s=t.currentWidget.sessionContext;if(!s.isReady)return;e.commands.execute("notebook:enter-command-mode");const o=null!==(l=x[s.session.id])&&void 0!==l?l:{},c=o.altModeExecuteCells;if(o.altModeExecuteCells=null,null!==(n=o.isIpyflowCommConnected)&&void 0!==n&&n){if(("batch"===o.settings.reactivity_mode||null===c)&&"code"===t.activeCell.model.type)if(o.numAltModeExecutes++,"incremental"===o.settings.reactivity_mode)1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>i.CodeCell.execute(t.activeCell,s))):i.CodeCell.execute(t.activeCell,s);else if("batch"===o.settings.reactivity_mode){let e=null!=c?c:[t.activeCell];"normal"===o.settings.exec_mode&&null===c&&(e=o.computeTransitiveClosure([t.activeCell.model.id])),1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>o.executeCells(e))):o.executeCells(e)}else console.error(`Unknown reactivity mode: ${o.settings.reactivity_mode}`)}else i.CodeCell.execute(t.activeCell,s)}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}});const n=l=>{var n,i;const s=t.currentWidget.sessionContext;if(!s.isReady)return;const o=null!==(n=x[s.session.id])&&void 0!==n?n:{};if(null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return;e.commands.execute("notebook:enter-command-mode");const c=o.computeTransitiveClosure([o.activeCell.model.id],!0,l);o.numPendingForcedReactiveCounterBumps++,"normal"===o.settings.exec_mode?o.executeCells(c):(o.altModeExecuteCells=c,e.commands.execute("alt-mode-execute"))};e.commands.addCommand("execute-forward-slice",{label:"Execute Forward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>n(!1)}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel J"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel ArrowDown"],selector:".jp-Notebook"}),e.commands.addCommand("execute-backward-slice",{label:"Execute Backward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>n(!0)}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel K"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel ArrowUp"],selector:".jp-Notebook"});const o=()=>{var e,l;const n=t.currentWidget.sessionContext;if(!n.isReady)return;const i=null!==(e=x[n.session.id])&&void 0!==e?e:{};if(null!==(l=i.isIpyflowCommConnected)&&void 0!==l&&l){let e=i.executionScheduledCells;i.executionScheduledCells=[],0===e.length&&(e=[i.activeCell.model.id]);const t=i.computeTransitiveClosure(e,!1);t.length>0?i.executeCells(t):i.requestComputeExecSchedule()}};s.NotebookActions.executionScheduled.connect(((e,l)=>{var n,i,s;const o=null==t?void 0:t.currentWidget;if((null==o?void 0:o.content)!==l.notebook)return;const c=null==o?void 0:o.sessionContext;if(null===(n=null==c?void 0:c.isReady)||void 0===n||!n)return;const d=null!==(i=x[c.session.id])&&void 0!==i?i:{};if(null===(s=d.isIpyflowCommConnected)||void 0===s||!s)return;const a=d.settings,r="batch"===(null==a?void 0:a.reactivity_mode),u="reactive"===(null==a?void 0:a.exec_mode);r&&u&&"code"===l.cell.model.type&&d.executionScheduledCells.push(l.cell.model.id)})),e.commands.commandExecuted.connect(((e,l)=>{var n,i,s;const c=null==t?void 0:t.currentWidget,d=null==c?void 0:c.sessionContext;if(null===(n=null==d?void 0:d.isReady)||void 0===n||!n)return;const a=null!==(i=x[d.session.id])&&void 0!==i?i:{};if(null===(s=a.isIpyflowCommConnected)||void 0===s||!s)return;const r=a.settings,u="batch"===(null==r?void 0:r.reactivity_mode),m="reactive"===(null==r?void 0:r.exec_mode);if(u)if("notebook:run-cell"===l.id)m?o():a.requestComputeExecSchedule();else if("notebook:run-cell-and-select-next"===l.id){const e=a.activeCell;try{a.activeCell=a.prevActiveCell,m?o():a.requestComputeExecSchedule()}finally{a.activeCell=e}}})),t.widgetAdded.connect(((e,l)=>{const n=l.sessionContext;let i=()=>p(n.session.id);const s=()=>{n.session.kernel.registerCommTarget("ipyflow-client",((e,s)=>{e.onMsg=e=>{var s;const o=e.content.data;(null===(s=o.success)||void 0===s||s)&&("unestablish"===o.type?i():"establish"===o.type&&(i(),i=B(n,t,l.content)))},i(),i=B(n,t,l.content)}))};n.ready.then((()=>{L(l.content),s(),i(),i=B(n,t,l.content),n.kernelChanged.connect(((e,o)=>{null!=o.newValue&&(L(l.content),i(),p(n.session.id),i=()=>p(n.session.id),n.ready.then((()=>{s(),i=B(n,t,l.content)})))}))}))}))}},E=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},R=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},k=(e,t,l)=>{const n=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",n)};e.addEventListener(t,l),e.addEventListener("cleanup",n)},b=(e,t,l,n,i)=>{null!==e&&null!==t&&k(e,l,(()=>{t.firstElementChild.classList[n](i)}))},I=(e,t)=>{b(E(e),R(e),"mouseover","add",m),b(E(e),R(e),"mouseout","remove",m),b(R(e),E(e),"mouseover","add",t),b(R(e),E(e),"mouseout","remove",t)},L=e=>{e.widgets.forEach((e=>{e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(C),e.node.classList.remove(h),e.node.classList.remove(y);const t=E(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(v),t.dispatchEvent(g));const l=R(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(v),l.dispatchEvent(g))}))},S=(e,t,l,n,i,s,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=v;o.has(e)&&(t=m);const i=n(l[e].node);if(null===i||null===i.firstElementChild)return;i.firstElementChild.classList[s](t)}};e.addEventListener(i,c),k(e,i,c)},B=(e,t,l)=>{var n,s,o;o=e.session.id,x[o]=new f;const g=x[e.session.id];g.activeCell=l.activeCell;const _=e.session.kernel.createComm("ipyflow","ipyflow");g.comm=_,g.notebook=l,g.session=e;let k=!1;const b=e=>{null!==e&&null!==e.model&&(e.model.isDirty?g.dirtyCells.add(e.model.id):g.dirtyCells.delete(e.model.id))},B=c().debounce((()=>{if(k)return void l.model.contentChanged.disconnect(B);const e=g.gatherCellMetadataAndContent();c().isEqual(e,g.lastCellMetadataMap)||(g.lastCellMetadataMap=e,l.widgets.forEach(b),_.send({type:"notify_content_changed",cell_metadata_by_id:e}))}),500),M=(e,t)=>{k?e.stateChanged.disconnect(M):"executionCount"===t.name&&null!==t.newValue&&(g.dirtyCells.delete(e.id),l.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),"incremental"===g.settings.reactivity_mode&&g.requestComputeExecSchedule())};for(const e of l.widgets)e.model.stateChanged.connect(M);const A=(e,t)=>{if(k)l.model.cells.changed.disconnect(A);else if("add"===t.type)for(const e of t.newValues)null==e||e.stateChanged.connect(M);else if("remove"===t.type)for(const e of t.oldValues)null==e||e.stateChanged.disconnect(M)};l.model.cells.changed.connect(A);const P=e=>{let t=-1;l.widgets.forEach(((l,n)=>{l.model.id===e.id&&(t=n)}));const n={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:t};_.send(n)},j=(e,t)=>{var n,i;l===e&&(k?l.activeCellChanged.disconnect(j):(P(t.model),g.prevActiveCell=g.activeCell,g.activeCell=t,null!==g.activeCell&&null!==g.activeCell.model&&"code"===g.activeCell.model.type&&(P(g.activeCell.model),g.dirtyCells.has(g.activeCell.model.id)&&(null===(i=(n=g.activeCell.model)._setDirty)||void 0===i||i.call(n,!0)),N(l))))},q=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],T=(e,t,l,n,i)=>{const s=g.cellsById[e].model;if("code"!==s.type)return;if(null==s.executionCount)return;const o=g.cellsById[e].node;t?o.classList.add(C):o.classList.remove(C),l&&!t?o.classList.add(h):o.classList.remove(h),!n||l||t?o.classList.remove(y):o.classList.add(y),i&&(g.waitingCells.has(e)?(o.classList.add(d),o.classList.add(a),o.classList.remove(u),I(o,m)):g.readyCells.has(e)&&(o.classList.add(u),o.classList.add(a),I(o,v)),"reactive"!==g.settings.exec_mode&&(void 0!==g.waiterLinks[e]&&q.forEach((({action:t,update:l})=>{S(E(o),g.waiterLinks[e],g.cellsById,E,t,l,g.waitingCells),S(R(o),g.waiterLinks[e],g.cellsById,E,t,l,g.waitingCells)})),void 0!==g.readyMakerLinks[e]&&(g.waitingCells.has(e)||(o.classList.add(r),o.classList.add(a)),q.forEach((({action:t,update:l})=>{S(E(o),g.readyMakerLinks[e],g.cellsById,E,t,l,g.waitingCells),S(E(o),g.readyMakerLinks[e],g.cellsById,R,t,l,g.waitingCells)})))))},N=e=>{L(e),(e=>{g.cellsById={},g.orderIdxById={},e.widgets.forEach(((e,t)=>{g.cellsById[e.model.id]=e,g.orderIdxById[e.model.id]=t}))})(e);const t=new Set;let l=new Set,n=g.selectedCells;0===n.length&&(n=[g.activeCell.model.id]);for(const e of n)void 0===g.cellChildren[e]&&void 0===g.cellParents[e]||(l=new Set([e,...l,...g.cellChildren[e],...g.cellParents[e]]),w(t,e,g.cellChildren),t.delete(e),w(t,e,g.cellParents));for(const[e]of Object.entries(g.cellsById))T(e,e===g.activeCell.model.id&&l.has(e),l.has(e),t.has(e),"none"!==g.lastExecutionHighlights)},F=()=>{var e,l,n;k&&t.selectionChanged.disconnect(F);const i=null==t?void 0:t.currentWidget,s=null==i?void 0:i.sessionContext;if(null===(e=null==s?void 0:s.isReady)||void 0===e||!e)return;const o=null!==(l=x[s.session.id])&&void 0!==l?l:{};if(null===(n=o.isIpyflowCommConnected)||void 0===n||!n)return;const c=i.content;o.selectedCells=c.widgets.filter((e=>"code"===e.model.type&&c.isSelected(e))).map((e=>e.model.id)),N(c)};t.selectionChanged.connect(F),_.onMsg=n=>{var s,o;const c=n.content.data;if(!k&&(null===(s=c.success)||void 0===s||s))if("establish"===c.type)g.isIpyflowCommConnected=!0,l.activeCellChanged.connect(j),l.activeCell.model.stateChanged.connect(M),P(l.activeCell.model),l.model.contentChanged.connect(B),g.requestComputeExecSchedule();else if("set_exec_mode"===c.type)g.numAltModeExecutes=0,g.settings.exec_mode=c.exec_mode;else if("compute_exec_schedule"===c.type){g.settings=c.settings,g.cellParents=c.cell_parents,g.cellChildren=c.cell_children,l.model.setMetadata("ipyflow",{cell_parents:g.cellParents,cell_children:g.cellChildren}),t.currentWidget.context.save(),g.waitingCells=new Set(c.waiting_cells),g.readyCells=new Set(c.ready_cells),0===g.numPendingForcedReactiveCounterBumps?(g.forcedReactiveCells=new Set([...g.forcedReactiveCells,...c.forced_reactive_cells]),g.forcedCascadingReactiveCells=new Set([...g.forcedCascadingReactiveCells,...c.forced_cascading_reactive_cells])):(g.forcedReactiveCells=new Set,g.forcedCascadingReactiveCells=new Set),g.waiterLinks=c.waiter_links,g.readyMakerLinks=c.ready_maker_links,g.cellPendingExecution=null;const n=c.exec_mode;g.isReactivelyExecuting=g.isReactivelyExecuting||null!==(o=null==c?void 0:c.is_reactively_executing)&&void 0!==o&&o||"reactive"===n,g.newReadyCells="reactive"===n?new Set([...g.newReadyCells,...c.new_ready_cells]):new Set;const s=c.flow_order,d=c.exec_schedule;g.lastExecutionHighlights=c.highlights;const a=c.last_executed_cell_id;g.executedReactiveReadyCells.add(a);let r=!1;if(c.last_execution_was_error)r=!0;else if("batch"===g.settings.reactivity_mode){const e=g.computeTransitiveClosure(Array.from(g.forcedCascadingReactiveCells).filter((e=>!g.executedReactiveReadyCells.has(e)))).map((e=>e.model.id));let t;t="reactive"===n?g.computeTransitiveClosure([...g.newReadyCells,...g.forcedReactiveCells,...e].filter((e=>!g.executedReactiveReadyCells.has(e)))).filter((e=>!g.executedReactiveReadyCells.has(e.model.id))):[...g.forcedReactiveCells,...e].filter((e=>!g.executedReactiveReadyCells.has(e)&&void 0!==g.cellsById[e]&&void 0!==g.orderIdxById[e])).sort(((e,t)=>g.orderIdxById[e]-g.orderIdxById[t])).map((e=>g.cellsById[e])),0===t.length?r=!0:(g.isReactivelyExecuting=!0,g.executedReactiveReadyCells=new Set([...g.executedReactiveReadyCells,...t.map((e=>e.model.id))]),g.executeCells(t))}else if("incremental"===g.settings.reactivity_mode){let t=!1;for(const e of l.widgets){if(!t&&(t=e.model.id===a,"in_order"===s||"strict"===d))continue;if("code"!==e.model.type||g.executedReactiveReadyCells.has(e.model.id))continue;if(!(g.forcedReactiveCells.has(e.model.id)||g.newReadyCells.has(e.model.id)&&"reactive"===n))continue;const l=e;if(null===g.cellPendingExecution){if(g.cellPendingExecution=l,"in_order"===s||"strict"===d)break}else null==l.model.executionCount||l.model.executionCount<g.cellPendingExecution.model.executionCount&&(g.cellPendingExecution=l)}null===g.cellPendingExecution?r=!0:(g.isReactivelyExecuting=!0,i.CodeCell.execute(g.cellPendingExecution,e))}r&&(g.isReactivelyExecuting&&("reactive"===g.lastExecutionHighlights&&(g.readyCells=g.executedReactiveReadyCells),_.send({type:"reactivity_cleanup"})),g.numAltModeExecutes>0&&0==--g.numAltModeExecutes&&g.toggleReactivity(),g.numPendingForcedReactiveCounterBumps>0&&g.bumpForcedReactiveCounter(),g.forcedReactiveCells=new Set,g.forcedCascadingReactiveCells=new Set,g.newReadyCells=new Set,g.executedReactiveReadyCells=new Set,g.isReactivelyExecuting=!1,N(l))}};const K=l.model.getMetadata("ipyflow");return _.open({interface:"jupyterlab",cell_metadata_by_id:g.gatherCellMetadataAndContent(),cell_parents:null!==(n=null==K?void 0:K.cell_parents)&&void 0!==n?n:{},cell_children:null!==(s=null==K?void 0:K.cell_children)&&void 0!==s?s:{}}),()=>{_.dispose(),k=!0,g.isIpyflowCommConnected=!1,p(e.session.id)}},M=_}}]);